#!/bin/bash

# Get the package name from pubspec.yaml
PACKAGE_NAME=$(grep -m1 '^name:' pubspec.yaml | awk '{print $2}')

# Set the lib directory path
LIB_DIR="lib"

# Detect macOS or Linux for sed compatibility
if [[ "$OSTYPE" == "darwin"* ]]; then
    SED_CMD="sed -i ''"
else
    SED_CMD="sed -i"
fi

# Find all Dart files in the lib directory
find "$LIB_DIR" -type f -name "*.dart" | while read -r file; do
    # Read file content and modify relative imports
    awk -v package="$PACKAGE_NAME" '
    {
        if ($0 ~ /^(import|export)[[:space:]]+[\"\x27](\.\.?\/[^\"\x27]+)[\"\x27];/) {
            match($0, /^(import|export)[[:space:]]+[\"\x27](\.\.?\/[^\"\x27]+)[\"\x27];/, arr);
            relative_path = arr[2];
            sub(/^\.\.\//, "", relative_path);  # Remove leading ../
            sub(/^\.\//, "", relative_path);    # Remove leading ./
            print arr[1] " \"package:" package "/" relative_path "\";";
        } else {
            print;
        }
    }' "$file" > temp_file && mv temp_file "$file"

    echo "Updated: $file"
done

echo "Conversion completed."